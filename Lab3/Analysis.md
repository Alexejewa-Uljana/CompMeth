# Документация к программе сжатия изображений SVD

## Общее описание

Программа выполняет сжатие монохромных BMP изображений с использованием сингулярного разложения (SVD) с контролируемым коэффициентом сжатия.

## Сжатие изображений с использованием сингулярного разложения матриц

### Математические основы

Программа реализует сжатие изображений на основе сингулярного разложения (SVD) матрицы пикселей.

#### Численные методы

**Сингулярное разложение (SVD):**
Для матрицы изображения A размера m×n вычисляется разложение:
```
A = U * S * V^T
```
где:
- U - матрица левых сингулярных векторов размера m×m
- S - диагональная матрица сингулярных значений (s1 ≥ s2 ≥ ... ≥ sr ≥ 0)
- V - матрица правых сингулярных векторов размера n×n

**Малоранговое приближение:**
Используется усеченное SVD ранга k:
```
A ≈ A_k = U_k * S_k * V_k^T
```
где U_k, S_k, V_k содержат только первые k компонент.

#### Формулы расчета

**Коэффициент сжатия:**
```
N = size_bmp / size_svc
```
где size_svc = 20 + (m×k + k + n×k)×4 байт

**Метрики качества:**
- MSE = (1/(m×n)) × сумма по всем пикселям (A_ij - A_k_ij)^2
- PSNR = 20 × log10(255 / sqrt(MSE))

## Структура программы

### Формат файла .svc
```
[Заголовок: 20 байт]
magic:4, version:2, mode:2, rows:4, cols:4, k:4
[Данные: переменный размер]
U: m×k×4, S: k×4, V: n×k×4 (все float32)
```

### Основные функции
- `create_svc_from_image()` - создание SVD-представления
- `write_svc_file()` - сохранение в бинарный формат
- `read_svc_file()` - чтение из файла
- `decompress_svd()` - восстановление изображения

## Эффективность метода

Алгоритм обеспечивает:
- Адаптивный выбор степени сжатия через параметр N
- Сохранение основных структур изображения
- Теоретически оптимальное приближение для заданного ранга
- Управляемое соотношение "качество-размер"

## Структура программы

### Основные классы и функции:

## Класс SVCFile

Структура для хранения промежуточного представления сжатого изображения.

**Поля:**
- magic (bytes) - идентификатор формата 'SVDC'
- version (int) - версия формата
- mode (str) - режим изображения ('1' или 'L')
- rows (int) - количество строк изображения
- cols (int) - количество столбцов изображения
- k (int) - количество сингулярных значений
- U (numpy.array) - левые сингулярные векторы
- S (numpy.array) - сингулярные значения
- V (numpy.array) - правые сингулярные векторы

**Назначение:** Служит контейнером для хранения всех данных SVD-разложения в структурированном виде. Обеспечивает единый интерфейс для доступа к параметрам изображения и матричным данным, упрощает процессы сериализации и десериализации.

## 1. create_svc_from_image(img_path, N)

**Назначение:** Создает структуру SVCFile из BMP изображения

**Параметры:**
- img_path (str) - путь к исходному BMP файлу
- N (int) - коэффициент сжатия

**Возвращает:**
- svc (SVCFile) - структура с данными SVD разложения

**Алгоритм работы:**
1. Загружает изображение с проверкой поддерживаемых форматов ('1' - бинарный, 'L' - оттенки серого)
2. Преобразует изображение в матрицу числовых значений для математической обработки
3. Рассчитывает исходный размер изображения в байтах с учетом формата хранения
4. Методом последовательного перебора находит максимальное количество сингулярных значений k, при котором размер сжатого файла не превышает размер_BMP / N
5. Выполняет полное SVD разложение матрицы изображения с использованием алгоритма из библиотеки scipy
6. Создает и возвращает объект SVCFile с усеченными матрицами, содержащими только k наибольших компонент

## 2. write_svc_file(svc, output_path)

**Назначение:** Сохраняет структуру SVCFile в файл

**Параметры:**
- svc (SVCFile) - структура с данными SVD
- output_path (str) - путь для сохранения файла

**Формат файла .svc:**
[magic: 4 байта - 'SVDC']
[version: 2 байта - uint16]
[mode: 2 байта - uint16 (0='1', 1='L')]
[rows, cols, k: 12 байт - 3×uint32]
[U: rows×k × 4 байта - float32]
[S: k × 4 байта - float32]
[V: cols×k × 4 байта - float32]

**Алгоритм работы:**
1. Записывает magic number 'SVDC' для идентификации собственного формата файла
2. Сохраняет версию формата для обеспечения обратной совместимости
3. Кодирует режим изображения в числовой формат для компактного хранения
4. Записывает размеры матриц и параметр k в бинарном формате
5. Последовательно сохраняет матрицы U, S, V в формате float32 для экономии дискового пространства
6. Обеспечивает целостность структуры файла для последующего корректного чтения

## 3. read_svc_file(input_path)

**Назначение:** Загружает структуру SVCFile из файла

**Параметры:**
- input_path (str) - путь к .svc файлу

**Возвращает:**
- svc (SVCFile) - восстановленная структура с данными SVD

**Алгоритм работы:**
1. Проверяет корректность файла по magic number для предотвращения обработки файлов неподдерживаемых форматов
2. Читает метаданные из заголовка файла, включая версию формата и параметры изображения
3. Восстанавливает режим изображения из числового флага в строковое представление
4. Загружает матричные данные с преобразованием бинарных данных в numpy массивы соответствующей размерности
5. Создает и возвращает полностью восстановленный объект SVCFile с готовыми к использованию матрицами

## 4. compress_bmp_svd(input_path, output_path, N)

**Назначение:** Сжимает BMP изображение в формат .svc

**Параметры:**
- input_path (str) - путь к исходному BMP файлу
- output_path (str) - путь для сохранения сжатого файла
- N (int) - коэффициент сжатия

**Возвращает:**
- k (int) - количество использованных сингулярных значений
- compressed_size (int) - размер сжатого файла

**Алгоритм работы:**
1. Координирует полный процесс сжатия, объединяя создание SVD-представления и его сохранение
2. Вызывает create_svc_from_image для преобразования изображения в SVD-форму
3. Использует write_svc_file для сериализации данных в бинарный файл
4. Вычисляет фактический достигнутый коэффициент сжатия на основе размеров исходного и сжатого файлов
5. Возвращает параметры сжатия для последующего анализа и сравнения эффективности алгоритма

## 5. decompress_svd(input_path, output_path)

**Назначение:** Восстанавливает изображение из .svc файла

**Параметры:**
- input_path (str) - путь к .svc файлу
- output_path (str) - путь для сохранения BMP

**Алгоритм работы:**
1. Организует полный цикл восстановления изображения из сжатого представления
2. Вызывает read_svc_file для загрузки и десериализации данных SVD-разложения
3. Выполняет матричное умножение U_k × diag(S_k) × V_k^T для восстановления приближенной матрицы изображения
4. Нормализует значения пикселей в зависимости от режима изображения (пороговая обработка для '1', clipping для 'L')
5. Сохраняет восстановленное изображение в формате BMP с сохранением исходного режима

## 6. create_example_images()

**Назначение:** Создает тестовые монохромные изображения

**Возвращает:**
- examples_created (list) - список путей к созданным файлам

**Создаваемые изображения:**
- example1.bmp (100×150) - геометрические фигуры
- example2.bmp (120×120) - градиенты
- example3.bmp (80×80) - сложная текстура

**Алгоритм работы:**
1. Создает разнообразные тестовые изображения для демонстрации работы алгоритма в различных условиях:
   - Геометрические фигуры для проверки сохранения резких границ и контуров
   - Градиенты для тестирования работы с плавными переходами яркости
   - Случайные текстуры для оценки обработки сложных паттернов и шума
2. Обеспечивает автоматическое создание необходимых тестовых данных при их отсутствии
3. Сохраняет изображения в выделенной папке для организации рабочего пространства

## 7. process_examples()

**Назначение:** Основная функция обработки примеров

**Алгоритм работы:**
1. Проверяет наличие тестовых изображений и при необходимости инициирует их создание
2. Организует комплексное тестирование алгоритма на различных коэффициентах сжатия (N=2,4,8)
3. Для каждой комбинации изображение-коэффициент выполняет полный цикл сжатия и восстановления
4. Вычисляет объективные метрики качества (MSE, PSNR) для количественной оценки результатов
5. Формирует структурированную сводную таблицу результатов для наглядного сравнения
6. Сохраняет подробный отчет в текстовый файл для документации и последующего анализа

## Метрики качества

MSE (Mean Squared Error) - средняя квадратичная ошибка:
mse = np.mean((original_img - reconstructed_img) ** 2)

PSNR (Peak Signal-to-Noise Ratio) - пиковое отношение сигнал/шум:
psnr = 20 * np.log10(255.0 / np.sqrt(mse)) if mse > 0 else float('inf')

## Используемые библиотеки

- numpy - работа с матрицами и математические операции
- scipy.linalg.svd - сингулярное разложение матриц
- PIL.Image - работа с изображениями
- struct - бинарная упаковка/распаковка данных
- os - работа с файловой системой